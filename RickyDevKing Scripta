local Players = game.Players
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character
local ItemFolder = game.Workspace:WaitForChild("Item")
local VirtualInputManager = game:GetService("VirtualInputManager")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Teleported, Active, Target, LastTeleported = false, false, nil, 0

local Items = {
    "Arrow", "Bari Bari Devil Fruit", "Barrel", "Bomu Bomu Devil Fruit", 
    "Mysterious Camera", "Hamon Manual", "Haunted Sword", "Mochi Mochi Devil Fruit", 
    "Rokakaka", "Spin Manual", "Stop Sign", "Stone Mask", "New Item"
}

local ChestKey = "Chest Key"
local Key1 = Enum.KeyCode.E
local Key2 = Enum.KeyCode.Z

local function HasChestKey()
    for _, item in ipairs(LocalPlayer.Backpack:GetChildren()) do
        if item:IsA("Tool") and item.Name == ChestKey then
            return true, item
        end
    end
    return false
end

local function EquipTool(item)
    if item and not Character:FindFirstChild(item.Name) then
        Character:WaitForChild("Humanoid"):EquipTool(item)
    end
end

local function TeleportToPart(part)
    if part and Character then
        Character:SetPrimaryPartCFrame(part.CFrame)
        Teleported, Target, LastTeleported = true, part, tick()
    end
end

local function PressKey(key)
    VirtualInputManager:SendKeyEvent(true, key, false, game)
end

local function ReleaseKey(key)
    VirtualInputManager:SendKeyEvent(false, key, false, game)
end

local function FindValidItems()
    local allItems = ItemFolder:GetChildren()
    local validItems = {}
    local chestKeyExists, chestKeyItem = HasChestKey()

    for _, item in ipairs(allItems) do
        if item:IsA("BasePart") then
            if chestKeyExists and item.Name == "Chest" then
                table.insert(validItems, item)
            elseif not chestKeyExists and (item.Name == "Box" or item.Name == "Barrel") then
                table.insert(validItems, item)
            elseif item.Name == "New Item" then
                table.insert(validItems, item)
            end
        end
    end
    return validItems
end

local function SellItems()
    for _, item in ipairs(LocalPlayer.Backpack:GetChildren()) do
        if item:IsA("Tool") then
            for _, validItemName in ipairs(Items) do
                if item.Name == validItemName then
                    ReplicatedStorage.GlobalUsedRemotes.SellItem:FireServer(item.Name)
                    break
                end
            end
        end
    end
end

local function BreakthroughAction()
    ReplicatedStorage.GlobalUsedRemotes.Breakthrough:FireServer()
end

local function UpgradeMasAction()
    ReplicatedStorage.GlobalUsedRemotes.UpgradeMas:FireServer()
end

local function ShowNotification(title, message, duration)
    game:GetService("StarterGui"):SetCore("SendNotification", {Title = title, Text = message, Duration = duration})
end

UserInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == Key2 then
        Active = not Active
        local state = Active and "Activated" or "Deactivated"
        ShowNotification("Script " .. state, "Press 'Z' again to " .. (Active and "stop" or "start") .. ".", 5)
    end
end)

ShowNotification("Sakura Stand Farming Script 2025", "Made by RickyDevKing", 5)

while true do
    if Active then
        local chestKeyExists, chestKeyItem = HasChestKey()
        if chestKeyExists and not Character:FindFirstChild(ChestKey) then
            EquipTool(chestKeyItem)
        end

        if #Players:GetPlayers() == 1 then
            local validItems = FindValidItems()
            if #validItems > 0 then
                local randomItem = validItems[math.random(1, #validItems)]
                if randomItem and randomItem ~= Target then
                    TeleportToPart(randomItem)
                    task.wait(1.5)
                    PressKey(Key1)
                    task.wait(1)

                    BreakthroughAction()
                    UpgradeMasAction()
                end
            elseif Teleported then
                ReleaseKey(Key1)
                Teleported = false
            end
            SellItems()
        end
    end
    task.wait()
end
